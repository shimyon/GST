@{
    Layout = "_Layout.cshtml";
}


@*<div class="sechead pb5 fs14 mt20 "><b>Quotation</b></div>*@
<div class="mt-5">
    <ul id="myTab" class="nav nav-tabs">
        <li class="active"><a class="nav-link" href="#Invoice" data-toggle="tab" aria-selected="true">Invoice</a></li>
        <li><a class="nav-link" href="#Invoice_items" data-toggle="tab">Invoice items</a></li>
        <li><a class="nav-link" href="#Template" data-toggle="tab">Template</a></li>
    </ul>

    <div id="Content" class="tab-content">
        <div class="tab-pane fade in active" id="Invoice">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Company Name</label>
                        <select class="form-control" id="CompanyName">
                            <option value="CompanyName">Select Company</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Contact Name</label>
                        <select class="form-control" id="ContactName">
                            <option value="">Select Contact</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4 ">
                    <div class="form-group">
                        <label for="inputAddress2">Invoice Date</label>
                        <input type="date" class="form-control" id="InvoiceDate">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col col-md-1">
                    <button type="button" class="btn btn-primary" onclick="saveInvoiceData();">Save</button>
                </div>
                <div class="col col-md-1">
                    <button type="button" class="btn btn-danger" onclick="goBack();">Cancel</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="Invoice_items">
            <div class="mt-1">
                <div style="margin-top:20px">
                    <table class="table table-striped table-hover"
                           id="tblInvoice"
                           cellspacing="0"
                           width="100%">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>HSN Code</th>
                                <th>Quantity</th>
                                <th>Rate</th>
                                <th>Discount</th>
                                <th>Discounted Price</th>
                                <th>Tax%</th>
                                <th>Tax Amount</th>
                                <th>Amount</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm mr-1" onclick="AddNewRow();">+ Add New</button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="SaveData();">Save</button>
                <div clss="text-right" style="margin-top: 10px">
                    <div class="row text-right">
                        <div class="col-md-4 offset-md-6">
                            <label for="inputAddress">Sub Total :</label>
                        </div>
                        <div class="col-md-2">
                            <input class="txtSubTotal" name="SubTotal" type="number" required placeholder="Sub Total" />
                        </div>
                    </div>

                    <div class="row text-right">
                        <div class="col-md-4 offset-md-6">
                            <label for="inputAddress">Total Tax :</label>
                        </div>
                        <div class="col-md-2">
                            <input class="txtTotalTax" name="TotalTax" type="number" required placeholder="Total Tax" />
                        </div>
                    </div>

                    @*<div class="row">
                            <div class="col-md-4 offset-md-6">
                                <div class="form-group">
                                    <select class="form-control" id="TDS">
                                        <option value="">Select TDS</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control float-right" placeholder="0.00000">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 offset-md-6">
                                <div class="form-group">
                                    <select class="form-control" id="TCS">
                                        <option value="">Select TCS</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control float-right" placeholder="0.00000">
                            </div>
                        </div>*@

                    <div class="row text-right">
                        <div class="col-md-4 offset-md-6">
                            <label for="inputAddress">Total :</label>
                        </div>
                        <div class="col-md-2">
                            <input class="txtTotal" name="Total" type="number" required placeholder="Total" />

                        </div>
                    </div>

                    <div style="margin-top: 10px">
                        <label for="inputAddress"><u>Extra Charges</u></label>
                        <button type="button" class="btn btn-outline-primary btn-sm float-right">+ Add New</button>
                    </div>

                </div>
            </div>

        </div>

        <div class="tab-pane fade in active" id="Template">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label>Template Name</label>
                        <select class="form-control" id="tmpInvoice" onchange="GetTemplateById()">
                            <option value="0">Select Template</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-left:1px !important">
                <div>
                    <textarea name="TemplateData" id="TemplateData" rows="10" cols="80"></textarea>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col">
                    <button type="button" class="btn btn-primary" onclick="PrintPDF();">Print</button>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="PrintPreview">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preview</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="the-frame" src="" style="width:100%; min-height:300px;height:100%;" allowfullscreen webkitallowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>






@section scripts {
    <script src="~/Content/ckeditor/ckeditor/ckeditor.js"></script>
    <script type="text/javascript">
        var id = querySt("id");
        var productList = [];
        var $tabs = $('#Content');
        var invoiceItemPrintstring='';

         $(function () {
             CKEDITOR.replace('TemplateData');
             init();
             $('a[href="#Invoice"]').click();
        })

        async function init() {
            await ProductDropDownAll();
            await CompanyDropDownAll();
            await ContactDropDownAll();
            await templateDropDownAll();
            if (id) {
                    GetUsingID();
                    GetById();
             }
        }


        function ProductDropDownAll() {
            return new Promise((result, error) => {
                ajaxcall.get({
                    url: AppConfig.ApiPath + "Product/ProductDropDownAll"
                }).then((res) => {
                    if (res) {
                       productList = res;
                    }
                    result();
                }, err => error(err));
            });
        }

       function CompanyDropDownAll() {
            return new Promise((result, error) => {
                ajaxcall.get({
                    url: AppConfig.ApiPath + "Company/CompanyDropDownAll"
                }).then((res) => {
                    if (res) {
                        for (var i in res) {
                            $("<option>").val(res[i].value).text(res[i].label).appendTo("#CompanyName");
                        }
                    }
                    result();
                }, err => error(err));
            });
        }

        function ContactDropDownAll() {
            return new Promise((result, error) => {
                ajaxcall.get({
                    url: AppConfig.ApiPath + "Contact/ContactDropDownAll"
                }).then((res) => {
                    if (res) {
                        for (var i in res) {
                            $("<option>").val(res[i].value).text(res[i].label).appendTo("#ContactName");
                        }
                    }
                    result();
                }, err => error(err));
            });
        }

         function templateDropDownAll() {
            return new Promise((result, error) => {
                ajaxcall.get({
                    url: AppConfig.ApiPath + "Template/GetTemplatesByGroup?templateFor=Invoice"
                }).then((res) => {
                    if (res) {
                        for (var i in res) {
                            $("<option>").val(res[i].value).text(res[i].label).appendTo("#tmpInvoice");
                        }
                    }
                    result();
                }, err => error(err));
            });
        }

         function GetTemplateById() {
            CKEDITOR.instances['TemplateData'].setData('');
            if ($("#tmpInvoice").val() == "0") {
                return false;
            }
            ajaxcall.post({
                url: AppConfig.ApiPath + "Template/GetById",
                data: {
                    Id: $("#tmpInvoice").val()
                }
            }).then((res) => {
                if (res) {
                    var invoiceTable = `<table class="table table-striped table-hover"
                       id="tblTemplate"
                        border=1
                       cellspacing="0"
                       width="100%">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>HSN Code</th>
                            <th>Quantity</th>
                            <th>Rate</th>
                            <th>Discount</th>
                            <th>Tax%</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>`;

                    invoiceTable = invoiceTable + invoiceItemPrintstring + `</tbody></table>`;

                    res.TemplateData = res.TemplateData.replace('{{Invoice_Table}}', invoiceTable);

                    CKEDITOR.instances['TemplateData'].setData(res.TemplateData);
                }
            }, err => alert(err));
        }

        function PrintPDF() {
            var value = CKEDITOR.instances['TemplateData'].getData()
            if (!value) {
                alert('Please enter Template Data');
                return false;
            }
            ajaxcall.file({
                url: AppConfig.ApiPath + "Print/PrintPDF",
                data: {
                    Id: id,
                    Action: 'Invoice',
                    TemplateFor: $("#tmpInvoice").val(),
                    TemplateData: CKEDITOR.instances['TemplateData'].getData(),
                }
            }).then(blobData => {
                var path = GenBlobURL(blobData);
                $('#the-frame').attr('src',path);
                //DownloadFileFromURL(blobData);
                $("#PrintPreview").modal('show');
            }, err => {
                alert(err.responseText);
            })
        }

        function convertDataURIToBinary(base64) {
            var raw = window.atob(base64);
            var rawLength = raw.length;
            var array = new Uint8Array(new ArrayBuffer(rawLength));

            for (var i = 0; i < rawLength; i++) {
                array[i] = raw.charCodeAt(i);
            }
            return array;
        }

        function ConvertDataToObject(Data) {
            var pdfAsDataUri = Data;
            var pdfAsArray = convertDataURIToBinary(pdfAsDataUri);
            var binaryData = [];
            binaryData.push(pdfAsArray);
            var dataPdf = url + window.URL.createObjectURL(new Blob(binaryData, { type: "application/pdf" }))
            return dataPdf;
        }


        function GetUsingID() {
            ajaxcall.post({
                url: AppConfig.ApiPath + "Invoice/GetUsingID",
                data: { "Id": id }
            }).then(function (res) {
                if (res) {
                    $("#CompanyName").val(res.CompanyID);
                    $("#ContactName").val(res.ContactID);
                    $("#InvoiceDate").val(res.InvoiceDateformate);
                }

            })
        }

         function GetById() {
            ajaxcall.post({
                url: AppConfig.ApiPath + "Invoice/GetById",
                data: { "Id": id }
            }).then(function (resdata) {
                if (resdata) {
                    invoiceItemPrintstring = '';
                    for (var i in resdata) {
                        AddNewRow();
                        var res = resdata[i];
                        $('.ProductNameSel:last').val(res.ProductName);
                        $('.HSNCode:last').val(res.HSNCode);
                        $('.txtQuentity:last').val(res.Quantity);
                        $('.RateTxt:last').val(res.Rate);
                        $('.txtDiscount:last').val(res.Discount);
                        $('.txtTax:last').val(res.Tax);
                        $('.txtAmount:last').val(res.Amount);
                        $('.txtTotal:last').val(res.Total);
                        invoiceItemPrintstring = invoiceItemPrintstring + '<tr>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '<td>' + $('.ProductNameSel:last option:selected').text() + '</td>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '<td>' + res.HSNCode + '</td>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '<td>' + res.Quantity + '</td>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '<td>' + res.Rate + '</td>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '<td>' + res.Discount + '</td>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '<td>' + res.Tax + '</td>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '<td>' + res.Amount + '</td>';
                        invoiceItemPrintstring = invoiceItemPrintstring + '</tr>';
                    }
                    subTotal();
                }
            })
        }

        function saveInvoiceData(){
             ajaxcall.post({
                    url: AppConfig.ApiPath + "Invoice/AddInvoData",
                    data: {
                        InvoiceID: id,
                        CompanyID: $("#CompanyName").val(),
                        ContactID: $("#ContactName").val(),
                        InvoiceDate: $("#InvoiceDate").val(),
                    }

                }).then(res => {
                    alert("Saved successfully");
                    $('#myTab a[href="#Invoice_items"]').tab('show');
                }, err => {
                    alert(err.responseJSON);
                })


        }

         function AddProducts() {
            for (var i in productList) {
                    $("<option>").val(productList[i].value).text(productList[i].label).data('DefaultRate',productList[i].DefultRate).appendTo('.ProductNameSel:last');
            }
            bindEvent();
        }

        function bindEvent() {
            $('.ProductNameSel').change(function(){
                var rate = $(this).find(':selected').data('DefaultRate');
                $(this).closest('.trOrder').find('.RateTxt').val(rate);
                update_amounts();
            });

            $('.txtQuentity').change(function(){
                update_amounts();
            });

            $('.Ratetxt').change(function(){
                update_amounts();
            });

            $('.txtDiscount').change(function(){
                discount();
            });

             $('.txtTax').change(function(){
                tax();
            });

        }

        function update_amounts() {
            $('.trOrder').each(function() {
                var qty = $(this).find('.txtQuentity').val();
                var price = $(this).find('.RateTxt').val();
                var amount = (qty*price);
                $(this).find('.txtAmount').val(amount);
            });
        }

         function discount() {
            $('.trOrder').each(function() {
                var ttl = $(this).find('.txtAmount').val();
                var disc = $(this).find('.txtDiscount').val();
                var amount = (ttl*disc)/100;
                var ttlprice = parseInt(ttl) - parseInt(amount);

                $(this).find('.txtDiscountedPrice').val(amount);
                $(this).find('.txtAmount').val(ttlprice);
            });
        }

        function tax() {
            $('.trOrder').each(function() {
                var ttl = $(this).find('.txtAmount').val();
                var tax = $(this).find('.txtTax').val();
                var amount = (ttl*tax)/100;

                $(this).find('.txtTaxAmount').val(amount);
            });
          subTotal();
        }

        function AddNewRow(){
        debugger
             $('#tblInvoice > tbody').append(`  <tr class="trOrder">
                    <td>
                        <div class="col pl-0 pr-0">
                            <select class="ProductNameSel">
                                <option value="">Product Name</option>
                            </select>
                        </div>
                    </td>
                    <td><input class="HSNCode" name="HSNCode" type="text" required placeholder="HSN Code" /></td>
                    <td>
                     <input type="number" class="txtQuentity" placeholder="Quantity">
                    </td>
                    <td><input class="RateTxt" name="Rate" type="number" required placeholder="Rate" /></td>
                    <td>
                        <input class="txtDiscount" name="Discount" type="number" required placeholder="Discount" min="0" max="100" />
                    </td>
                    <td><input class="txtDiscountedPrice" name="Discounted Price" type="number" required placeholder="Discounted Price"/></td>
                    <td><input class="txtTax" name="Tax" type="number" required placeholder="Tax%" min="0" max="100"/></td>
                    <td><input class="txtTaxAmount" name="Tax" type="number" required placeholder="Tax%" min="0" max="100"/></td>
                    <td><input class="txtAmount" name="Amount" type="text" required placeholder="Amount" /></td>
                    <td><i class="fas fa-times btnDelete"></i></td>
                </tr>`);
            $("#tblInvoice").on('click', '.btnDelete', function () {
             $(this).closest('tr').remove();
             subTotal();
           });
           AddProducts();
           subTotal();
        }


      function subTotal(){
        var sum = 0;
        var tax = 0;

        $('.txtAmount').each(function() {
            sum += Number($(this).val());
        });
        $('.txtTaxAmount').each(function() {
            tax += Number($(this).val());
        });

         $('.txtSubTotal').val(+Number(sum));
         $('.txtTotalTax').val(+Number(tax));

        var ttlprice = parseInt(sum) + parseInt(tax);
         $('.txtTotal').val(+Number(ttlprice));

        }

        function SaveData(){
            debugger
            var datasend = [];
            $('.trOrder').each(function() {
                datasend.push({
                    InvoiceID: id,
                    ProductName: $('.ProductNameSel',this).val(),
                    HSNCode: $('.HSNCode',this).val(),
                    Quantity:$('.txtQuentity',this).val(),
                    Rate: $('.RateTxt',this).val(),
                    Discount: $('.txtDiscount',this).val(),
                    Tax: $('.txtTax',this).val(),
                    Amount: $('.txtAmount',this).val()
                });
            });

            ajaxcall.post({ url: AppConfig.ApiPath + "Invoice/AddInvoData", data: { Total: $('.txtTotal',this).val() }  })

            ajaxcall.post({
                    url: AppConfig.ApiPath + "Invoice/AddData",
                    data: {invoice_itemsobj: datasend}
                }).then(res => {
                    alert("Saved successfully");
                    $('a[href="#Template"]').click();
                }, err => {
                    alert(err.responseJSON);
                })

        }

         function goBack() {
                 window.history.back();
        }

    </script>
}
